<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIST RSI Tarayıcı - Profesyonel Analiz</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --border-hover: #cbd5e1;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 12px;
        }

        [data-theme="dark"] {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --secondary-color: #94a3b8;
            --success-color: #22c55e;
            --warning-color: #fbbf24;
            --danger-color: #f87171;
            --bg-primary: #1e293b;
            --bg-secondary: #0f172a;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border-color: #334155;
            --border-hover: #475569;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3), 0 2px 4px -2px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-secondary);
            padding: 24px;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .header {
            background: var(--bg-primary);
            padding: 32px 32px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-content h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }

        .header-content p {
            font-size: 16px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .theme-toggle:hover {
            background: var(--border-hover);
        }

        .controls {
            padding: 32px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-item label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.4;
        }

        .control-item select,
        .control-item input {
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .control-item select:focus,
        .control-item input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
        }

        .control-item select:hover,
        .control-item input:hover {
            border-color: var(--border-hover);
        }

        .market-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 24px;
        }

        .market-filter {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            color: var(--text-secondary);
            user-select: none;
        }

        .market-filter:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .market-filter.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .market-filter.active:hover {
            background: var(--primary-hover);
        }

        .filter-info {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            margin-bottom: 24px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .scan-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: var(--radius-md);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-sm);
        }

        .scan-button:hover:not(:disabled) {
            background: var(--primary-hover);
            box-shadow: var(--shadow-md);
        }

        .scan-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress {
            padding: 24px 32px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            text-align: center;
        }

        .results {
            padding: 32px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow-md);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .results-table th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 1px solid var(--border-color);
        }

        .results-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .results-table tr:last-child td {
            border-bottom: none;
        }

        .results-table tbody tr:hover {
            background: var(--bg-secondary);
        }

        .signal-badge {
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 500;
            color: white;
            display: inline-block;
        }

        .signal-rsi {
            background: var(--success-color);
        }

        .signal-div {
            background: var(--danger-color);
        }

        .signal-both {
            background: var(--warning-color);
            color: var(--text-primary);
        }

        .signal-oversold {
            background: var(--primary-color);
        }

        .signal-strong {
            background: var(--warning-color);
            color: var(--text-primary);
        }

        .rsi-value {
            font-weight: 600;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .rsi-low {
            color: var(--danger-color);
        }

        .rsi-medium {
            color: var(--warning-color);
        }

        .rsi-high {
            color: var(--success-color);
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 16px;
            border-radius: var(--radius-md);
            margin: 20px 0;
            border: 1px solid;
            font-size: 14px;
        }

        .alert-error {
            background: #fef2f2;
            color: #991b1b;
            border-color: #fecaca;
        }

        [data-theme="dark"] .alert-error {
            background: #450a0a;
            color: #fca5a5;
            border-color: #7f1d1d;
        }

        .no-results {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .no-results h3 {
            font-size: 18px;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .no-results p {
            font-size: 14px;
            line-height: 1.5;
        }

        .symbol-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .symbol-link:hover {
            text-decoration: underline;
        }

        .price-change {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-weight: 600;
        }

        .price-change.positive {
            color: var(--success-color);
        }

        .price-change.negative {
            color: var(--danger-color);
        }

        .volume-info {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-controls {
                width: 100%;
                justify-content: flex-end;
            }

            .control-group {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .market-filters {
                justify-content: center;
            }

            .controls,
            .results {
                padding: 24px;
            }

            .header-content h1 {
                font-size: 24px;
            }

            .results-table {
                font-size: 13px;
            }

            .results-table th,
            .results-table td {
                padding: 12px 8px;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
        }

        @media (max-width: 480px) {
            .stats {
                grid-template-columns: 1fr;
            }

            .market-filters {
                flex-direction: column;
                align-items: stretch;
            }

            .market-filter {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>BIST RSI Tarayıcı</h1>
                <p>Profesyonel hisse analizi ve RSI divergence tespiti</p>
            </div>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">🌙</span>
                    <span id="themeText">Karanlık Mod</span>
                </button>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label for="timeframe">Zaman Dilimi</label>
                    <select id="timeframe">
                        <option value="1d">Günlük (1d)</option>
                        <option value="4h">4 Saatlik (4h)</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label for="rsiPeriod">RSI Periyodu</label>
                    <input type="number" id="rsiPeriod" value="5" min="2" max="50">
                </div>
                
                <div class="control-item">
                    <label for="rsiThreshold">RSI Eşiği</label>
                    <input type="number" id="rsiThreshold" value="30" min="10" max="50">
                </div>
                
                <div class="control-item">
                    <label for="rsiDirection">RSI Yönü</label>
                    <select id="rsiDirection">
                        <option value="below">Aşırı Satım (RSI < Eşik)</option>
                        <option value="above">Güçlü Momentum (RSI > Eşik)</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label for="stockLimit">Hisse Limiti</label>
                    <input type="number" id="stockLimit" value="50" min="10" max="500">
                </div>
            </div>

            <div class="market-filters">
                <div class="market-filter active" data-market="all">
                    📊 Tüm Pazarlar (<span id="allCount">0</span>)
                </div>
                <div class="market-filter" data-market="main">
                    🏛️ Ana Pazar (<span id="mainCount">0</span>)
                </div>
                <div class="market-filter" data-market="stars">
                    ⭐ Stars Pazarı (<span id="starsCount">0</span>)
                </div>
                <div class="market-filter" data-market="pmt">
                    🔧 PMT Pazarı (<span id="pmtCount">0</span>)
                </div>
                <div class="market-filter" data-market="sub">
                    📈 Alt Pazarlar (<span id="subCount">0</span>)
                </div>
            </div>

            <div class="filter-info" id="filterInfo">
                Seçili: <strong>Tüm Pazarlar</strong> - <span id="selectedCount">0</span> hisse taranacak
            </div>
            
            <button class="scan-button" onclick="startScan()" id="scanBtn">
                <span>Taramayı Başlat</span>
            </button>
        </div>

        <div class="progress" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Tarama başlıyor...</div>
        </div>

        <div class="results" id="resultsSection">
            <div class="stats" id="statsSection" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalScanned">0</div>
                    <div class="stat-label">Taranan Hisse</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="foundSignals">0</div>
                    <div class="stat-label">Sinyal Bulunan</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successRate">0%</div>
                    <div class="stat-label">Başarı Oranı</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgRsi">0</div>
                    <div class="stat-label">Ortalama RSI</div>
                </div>
            </div>

            <div id="resultsContainer">
                <div class="no-results">
                    <h3>Analiz Hazır</h3>
                    <p>BIST hisselerini RSI divergence kriterlerine göre taramak için yukarıdaki butona tıklayın</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Konfigürasyon
        const CONFIG = {
            CORS_PROXY: 'https://api.allorigins.win/raw?url=',
            API_DELAY: 100, // ms
            MAX_RETRIES: 3,
            TIMEOUT: 10000 // ms
        };

        // BIST Hisse Listesi (Güncellenmiş - Tüm Pazarlar)
        const BIST_STOCKS = {
            // ANA PAZAR (MAIN MARKET)
            main: [
                'AKBNK', 'ARCLK', 'ASELS', 'BIMAS', 'EREGL', 'FROTO', 'GARAN', 'HALKB', 'ISCTR', 'KCHOL',
                'PGSUS', 'SAHOL', 'SISE', 'TKFEN', 'TUPRS', 'VAKBN', 'YKBNK', 'THYAO', 'TCELL', 'OTKAR',
                'MGROS', 'AEFES', 'AKSA', 'ALARK', 'AYGAZ', 'CIMSA', 'CCOLA', 'DOHOL', 'ENKAI', 'FENER',
                'GOLTS', 'GUBRF', 'HEKTS', 'IHLAS', 'KORDS', 'KOZAA', 'KOZAL', 'KRDMD', 'LOGO', 'MAVI',
                'PETKM', 'SASA', 'TOASO', 'ULKER', 'VESTL'
            ],
            
            // STARS PAZARI (Gelişen Şirketler)
            stars: [
                'ALBRK', 'ALKIM', 'ANSGR', 'BAGFS', 'BANVT', 'BFREN', 'BRSAN', 'BURVA', 'CANTE', 'CEMTS',
                'CLEBI', 'CRFSA', 'DARDL', 'DERIM', 'DGNMO', 'DITAS', 'DURDO', 'ECILC', 'EGEEN', 'EMKEL',
                'FORTE', 'FRIGO', 'GENTS', 'GOODY', 'GOZDE', 'HATEK', 'HEKTS', 'HEPSI', 'HUBVC', 'INVEO',
                'KAREL', 'KARTN', 'KLMSN', 'KOTON', 'LINK', 'MAGEN', 'MARTI', 'MEGAP', 'MERKO', 'NETAS',
                'PAPIL', 'PARSN', 'PATEK', 'PENTA', 'PKENT', 'QUAGR', 'RAYSG', 'SELEC', 'SMART', 'SMRTG',
                'TERA', 'TTKOM', 'TURSG', 'VERTU', 'YAYLA'
            ],
            
            // PMT PAZARI (Özel Durumlar)
            pmt: [
                'ASELC', 'ATEKS', 'AVHOL', 'BAKAB', 'BALAT', 'BASCM', 'BMEKS', 'BOBET', 'BOSSA', 'BTCIM',
                'BUCIM', 'BURCE', 'CARSI', 'CEMAS', 'CMBTN', 'CONSE', 'COSMO', 'DAGI', 'DAPGM', 'DENGE',
                'DERHL', 'DESA', 'DESPC', 'DIRIT', 'DMSAS', 'DOAS', 'DOBUR', 'DOCO', 'DOGUB', 'DOKTA',
                'EBEBK', 'ECZYT', 'EDATA', 'EGGUB', 'EGPRO', 'EGSER', 'EKIZ', 'ELDEM', 'EMNIS', 'ENERY',
                'ENJSA', 'ENLKR', 'ENOBH', 'ENSRI', 'EPLAS'
            ],
            
            // ALT PAZARLAR (SUB-MARKETS)
            sub: [
                'ANHYT', 'BARMA', 'BAYRK', 'BERA', 'BEYAZ', 'BJKAS', 'BLCYT', 'BMSCH', 'BRYAT', 'BSOKE',
                'CRDFA', 'CWENE', 'DZGYO', 'DYOBY', 'ERBOS', 'ERCB', 'ERSU', 'ESCAR', 'ESCOM', 'ESEN',
                'ETILR', 'ETYAT', 'EUHOL', 'EUKYO', 'EUPWR', 'EUREN', 'EUYO', 'EYGYO', 'FADE', 'FLAP',
                'FMIZP', 'GARFA', 'GEDIK', 'GEDZA', 'GEREL', 'GESAN', 'GIMAT', 'GLYHO', 'GMTAS', 'GOKNR',
                'GRNYO', 'GRSEL', 'GRTRK', 'GSDDE', 'GSDHO', 'GSRAY', 'GWIND', 'GZNMI', 'HATSN', 'HDFGS',
                'HEDEF', 'HEKTG', 'HKTM', 'HLGYO', 'HTTBT', 'HUNER', 'HUNNU', 'HURGZ', 'ICBCT', 'ICUGS',
                'IDGYO', 'IEYHO', 'IHAAS', 'IHEVA', 'IHGZT', 'IHLGM', 'IHYAY', 'IMASM', 'INDES', 'INFO',
                'INTEM', 'INVES', 'IPEKE', 'ISATR', 'ISBIR', 'ISBTR', 'ISDMR', 'ISFIN', 'ISGSY', 'ISGYO',
                'ISKPL', 'ISKUR', 'ISMEN', 'ISSEN', 'ISYAT', 'IZENR', 'JANTS', 'KAPLM', 'KARSN', 'KATMR',
                'KAYSE', 'KCAER', 'KENT', 'KERVT', 'KFEIN', 'KGYO', 'KIMMR', 'KLKIM', 'KLNMA', 'KLRHO',
                'KLSER', 'KLSYN', 'KMPUR', 'KNFRT', 'KONYA', 'KOPOL', 'KRDMA', 'KRDMB', 'KREDS', 'KRPLS',
                'KRSTL', 'KRTEK', 'KRVGD', 'KSTUR', 'KTLEV', 'KTSKR', 'KUTPO', 'KUVVA', 'KZGYO', 'LIDER',
                'LKMNH', 'LRSHO', 'LUKSK', 'LYDHO', 'MAALT', 'MACKO', 'MAKIM', 'MAKTK', 'MAMAK', 'MANAS',
                'MARBL', 'MARKA', 'MEDTR', 'MEKAG', 'MEMSA', 'MERCN', 'MERIT', 'METRO', 'MHRGY', 'MIGRS',
                'MIPAZ', 'MMCAS', 'MNDRS', 'MNDTR', 'MOBTL', 'MODO', 'MOGAN', 'MSGYO', 'MTRKS', 'MTRYO',
                'MZHLD', 'NATEN', 'NIBAS', 'NTHOL', 'NTTUR', 'NUHCM', 'NUGYO', 'OBAMS', 'ODAS', 'ONCSM',
                'ORCAY', 'ORGE', 'ORMA', 'OSMEN', 'OSTIM', 'OYAKC', 'OYLUM', 'OZBAL', 'OZCAM', 'OZGYO',
                'OZRDN', 'OZSUB', 'PAGYO', 'PAMEL', 'PASEU', 'PCILT', 'PDEKS', 'PENGD', 'PETUN', 'PINSU',
                'PKART', 'PLTUR', 'PMSEC', 'POLHO', 'POLTK', 'PRDGS', 'PRKAB', 'PRKME', 'PRZMA', 'PSDTC',
                'QNBFB', 'QNBFL', 'RALYH', 'REEDR', 'REGXY', 'REYSN', 'RHEAG', 'RLCNS', 'RODRG', 'ROYAL',
                'RTALB', 'RUBNS', 'RYDEN', 'SAFKR', 'SAMAT', 'SANEL', 'SANFM', 'SANKO', 'SARKY', 'SAYAS',
                'SDTTR', 'SEKFK', 'SELGD', 'SEYKM', 'SILVR', 'SINPAS', 'SKBNK', 'SKPLC', 'SKYMD', 'SNGYO',
                'SNKRN', 'SNPAM', 'SODSN', 'SOKM', 'SONME', 'SRVGY', 'SUMAS', 'SUNTK', 'SURGY', 'SUWEN',
                'SZKGY', 'TATGD', 'TATEN', 'TAVHL', 'TBORG', 'TDGYO', 'TEKTU', 'TETMT', 'TEZOL', 'TGSAS',
                'TIRE', 'TKNSA', 'TLMAN', 'TMPOL', 'TMSN', 'TNZTP', 'TOGTL', 'TOHOL', 'TRCAS', 'TRGYO',
                'TRILC', 'TSKB', 'TSPOR', 'TTRAK', 'TUKAS', 'TUREX', 'TURGG', 'UFUK', 'ULAS', 'ULUUN',
                'UNLU', 'USAK', 'UZERB', 'VAKFN', 'VANGD', 'VBTYZ', 'VEDAT', 'VEHBI', 'VESBE', 'VIFIN',
                'VKING', 'VKGYO', 'VRGYO', 'VRLGY', 'YAPRK', 'YATAS', 'YEOTK', 'YESIL', 'YGGYO', 'YGYO',
                'YONGA', 'YUNSA', 'YYAPI', 'ZEDUR', 'ZENSN', 'ZINTR', 'ZIRVE', 'ZOREN'
            ]
        };

        // Global State
        let scanResults = [];
        let isScanning = false;
        let scanAbortController = null;
        let selectedMarket = 'all';

        // Theme Management
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            updateThemeButton(newTheme);
        }

        function updateThemeButton(theme) {
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            if (theme === 'dark') {
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Açık Mod';
            } else {
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Karanlık Mod';
            }
        }

        // Market Filter Management
        function getSelectedStocks() {
            if (selectedMarket === 'all') {
                return Object.values(BIST_STOCKS).flat();
            }
            return BIST_STOCKS[selectedMarket] || [];
        }

        function updateMarketCounts() {
            document.getElementById('allCount').textContent = Object.values(BIST_STOCKS).flat().length;
            document.getElementById('mainCount').textContent = BIST_STOCKS.main.length;
            document.getElementById('starsCount').textContent = BIST_STOCKS.stars.length;
            document.getElementById('pmtCount').textContent = BIST_STOCKS.pmt.length;
            document.getElementById('subCount').textContent = BIST_STOCKS.sub.length;
        }

        function updateFilterInfo() {
            const selectedStocks = getSelectedStocks();
            const stockLimit = parseInt(document.getElementById('stockLimit').value);
            const actualCount = Math.min(selectedStocks.length, stockLimit);
            const rsiDirection = document.getElementById('rsiDirection').value;
            const rsiThreshold = document.getElementById('rsiThreshold').value;
            
            const marketNames = {
                'all': 'Tüm Pazarlar',
                'main': 'Ana Pazar',
                'stars': 'Stars Pazarı',
                'pmt': 'PMT Pazarı',
                'sub': 'Alt Pazarlar'
            };
            
            const directionText = rsiDirection === 'above' ? 
                `Güçlü Momentum (RSI > ${rsiThreshold})` : 
                `Aşırı Satım (RSI < ${rsiThreshold})`;
            
            document.getElementById('selectedCount').textContent = actualCount;
            document.getElementById('filterInfo').innerHTML = `
                Seçili: <strong>${marketNames[selectedMarket]}</strong> - ${actualCount} hisse | 
                <strong>${directionText}</strong>
            `;
        }

        function selectMarket(market) {
            selectedMarket = market;
            
            // Update active filter button
            document.querySelectorAll('.market-filter').forEach(filter => {
                filter.classList.remove('active');
            });
            document.querySelector(`[data-market="${market}"]`).classList.add('active');
            
            updateFilterInfo();
        }

        // Utility Functions
        const Utils = {
            delay: (ms) => new Promise(resolve => setTimeout(resolve, ms)),
            
            formatNumber: (num, decimals = 2) => {
                return new Intl.NumberFormat('tr-TR', {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                }).format(num);
            },
            
            formatVolume: (volume) => {
                if (volume >= 1000000) {
                    return (volume / 1000000).toFixed(1) + 'M';
                } else if (volume >= 1000) {
                    return (volume / 1000).toFixed(1) + 'K';
                }
                return volume.toString();
            },
            
            clamp: (value, min, max) => Math.min(Math.max(value, min), max),
            
            isValidNumber: (value) => typeof value === 'number' && !isNaN(value) && isFinite(value)
        };

        // Technical Analysis Functions
        const TechnicalAnalysis = {
            calculateRSI: (prices, period = 14) => {
                if (prices.length < period + 1) return [];
                
                const gains = [];
                const losses = [];
                
                for (let i = 1; i < prices.length; i++) {
                    const change = prices[i] - prices[i - 1];
                    gains.push(change > 0 ? change : 0);
                    losses.push(change < 0 ? Math.abs(change) : 0);
                }
                
                const rsiValues = [];
                
                // İlk RSI hesabı (SMA)
                let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
                let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
                
                if (avgLoss === 0) {
                    rsiValues.push(100);
                } else {
                    const rs = avgGain / avgLoss;
                    rsiValues.push(100 - (100 / (1 + rs)));
                }
                
                // Wilder's smoothing
                for (let i = period; i < gains.length; i++) {
                    avgGain = (avgGain * (period - 1) + gains[i]) / period;
                    avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
                    
                    if (avgLoss === 0) {
                        rsiValues.push(100);
                    } else {
                        const rs = avgGain / avgLoss;
                        rsiValues.push(100 - (100 / (1 + rs)));
                    }
                }
                
                return rsiValues;
            },

            calculateOHLC4: (ohlcData) => {
                return ohlcData.map(candle => {
                    const { open, high, low, close } = candle;
                    if (!Utils.isValidNumber(open) || !Utils.isValidNumber(high) || 
                        !Utils.isValidNumber(low) || !Utils.isValidNumber(close)) {
                        return null;
                    }
                    return (open + high + low + close) / 4;
                }).filter(value => value !== null);
            },

            detectBullishDivergence: (ohlc4, rsi, params = {}) => {
                const {
                    shortLookback = 5,
                    longLookback = 34,
                    reversalPct = 0.02,
                    oversoldLevel = 30,
                    minRsiStrength = 5.0
                } = params;
                
                if (ohlc4.length < longLookback + 10 || rsi.length < longLookback + 10) {
                    return { detected: false, reason: 'Insufficient data' };
                }
                
                try {
                    const currentPrice = ohlc4[ohlc4.length - 1];
                    const currentRsi = rsi[rsi.length - 1];
                    
                    // Fiyat Lower Low kontrolü
                    const recentPrices = ohlc4.slice(-shortLookback);
                    const lowestRecent = Math.min(...recentPrices);
                    const priceCondition1 = currentPrice > lowestRecent * (1 + reversalPct);
                    
                    const pastPrices = ohlc4.slice(-(longLookback + shortLookback), -longLookback);
                    const lowestPast = Math.min(...pastPrices);
                    const priceCondition2 = lowestRecent < lowestPast;
                    
                    const priceLL = priceCondition1 && priceCondition2;
                    
                    // RSI Higher Low kontrolü
                    const recentRsi = rsi.slice(-shortLookback);
                    const lowestRecentRsi = Math.min(...recentRsi);
                    const rsiCondition1 = currentRsi > lowestRecentRsi;
                    
                    const pastRsi = rsi.slice(-(longLookback + shortLookback), -longLookback);
                    const lowestPastRsi = Math.min(...pastRsi);
                    const rsiCondition2 = lowestRecentRsi > lowestPastRsi;
                    const rsiCondition3 = lowestRecentRsi < oversoldLevel;
                    const rsiCondition4 = currentRsi - lowestRecentRsi >= minRsiStrength;
                    
                    const rsiHL = rsiCondition1 && rsiCondition2 && rsiCondition3 && rsiCondition4;
                    
                    return {
                        detected: priceLL && rsiHL,
                        priceLL,
                        rsiHL,
                        strength: rsiCondition4 ? currentRsi - lowestRecentRsi : 0
                    };
                    
                } catch (error) {
                    return { detected: false, reason: 'Analysis error: ' + error.message };
                }
            }
        };

        // Data Fetching
        const DataFetcher = {
            async fetchWithRetry(url, retries = CONFIG.MAX_RETRIES) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);
                        
                        const response = await fetch(url, {
                            signal: controller.signal,
                            headers: {
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                            }
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        return await response.json();
                        
                    } catch (error) {
                        if (i === retries - 1) throw error;
                        await Utils.delay(1000 * (i + 1)); // Exponential backoff
                    }
                }
            },

            async fetchStockData(symbol, timeframe = '1d') {
                try {
                    const period = timeframe === '1d' ? '6mo' : '3mo';
                    const interval = timeframe;
                    
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}.IS?period1=0&period2=9999999999&interval=${interval}&includePrePost=false`;
                    const proxyUrl = CONFIG.CORS_PROXY + encodeURIComponent(url);
                    
                    const data = await this.fetchWithRetry(proxyUrl);
                    
                    if (!data.chart || !data.chart.result || data.chart.result.length === 0) {
                        throw new Error('No data available');
                    }
                    
                    const result = data.chart.result[0];
                    const timestamps = result.timestamp;
                    const quote = result.indicators.quote[0];
                    
                    const ohlcData = [];
                    for (let i = 0; i < timestamps.length; i++) {
                        const open = quote.open[i];
                        const high = quote.high[i];
                        const low = quote.low[i];
                        const close = quote.close[i];
                        const volume = quote.volume[i];
                        
                        if (Utils.isValidNumber(open) && Utils.isValidNumber(high) && 
                            Utils.isValidNumber(low) && Utils.isValidNumber(close)) {
                            ohlcData.push({
                                timestamp: timestamps[i],
                                open,
                                high,
                                low,
                                close,
                                volume: volume || 0
                            });
                        }
                    }
                    
                    return ohlcData;
                    
                } catch (error) {
                    console.error(`Error fetching data for ${symbol}:`, error.message);
                    return null;
                }
            }
        };

        // Stock Analysis
        const StockAnalyzer = {
            async analyzeStock(symbol, timeframe, rsiPeriod, rsiThreshold, rsiDirection) {
                const data = await DataFetcher.fetchStockData(symbol, timeframe);
                if (!data || data.length < 50) {
                    return { success: false, reason: 'Insufficient data' };
                }
                
                const ohlc4 = TechnicalAnalysis.calculateOHLC4(data);
                const rsi = TechnicalAnalysis.calculateRSI(ohlc4, rsiPeriod);
                
                if (rsi.length < 2) {
                    return { success: false, reason: 'RSI calculation failed' };
                }
                
                const currentRsi = rsi[rsi.length - 1];
                const previousRsi = rsi[rsi.length - 2];
                const currentPrice = data[data.length - 1].close;
                const volume = data[data.length - 1].volume;
                
                // RSI yönüne göre temel kriter kontrolü
                let basicCriteria = false;
                let signalDescription = '';
                
                if (rsiDirection === 'above') {
                    // RSI eşiğin üstünde ve yükseliş trendinde
                    basicCriteria = currentRsi > rsiThreshold && currentRsi > previousRsi;
                    signalDescription = 'RSI>' + rsiThreshold + ' (Güçlü)';
                } else {
                    // RSI eşiğin altında ve düşüş trendinde (aşırı satım)
                    basicCriteria = currentRsi < rsiThreshold && currentRsi > previousRsi;
                    signalDescription = 'RSI<' + rsiThreshold + ' (Aşırı Satım)';
                }
                
                // Bullish divergence tespiti (sadece aşırı satım durumunda)
                const divergenceResult = rsiDirection === 'below' ? 
                    TechnicalAnalysis.detectBullishDivergence(ohlc4, rsi, {
                        shortLookback: 5,
                        longLookback: 34,
                        reversalPct: 0.02,
                        oversoldLevel: rsiThreshold,
                        minRsiStrength: 5.0
                    }) : { detected: false };
                
                if (basicCriteria || divergenceResult.detected) {
                    const signalTypes = [];
                    if (basicCriteria) signalTypes.push(signalDescription);
                    if (divergenceResult.detected) signalTypes.push('BULLISH_DIV');
                    
                    return {
                        success: true,
                        data: {
                            symbol,
                            currentPrice,
                            currentRsi,
                            previousRsi,
                            rsiChange: currentRsi - previousRsi,
                            signalType: signalTypes.join(' + '),
                            volume,
                            timestamp: data[data.length - 1].timestamp,
                            divergenceStrength: divergenceResult.strength || 0,
                            rsiDirection
                        }
                    };
                }
                
                return { success: false, reason: 'No signals found' };
            }
        };

        // UI Controller
        const UIController = {
            updateProgress(current, total, symbol) {
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                
                const progress = (current / total) * 100;
                progressFill.style.width = progress + '%';
                progressText.textContent = `${symbol} analiz ediliyor... (${current}/${total})`;
            },

            showProgress() {
                document.getElementById('progressSection').style.display = 'block';
            },

            hideProgress() {
                document.getElementById('progressSection').style.display = 'none';
            },

            updateScanButton(isScanning) {
                const scanBtn = document.getElementById('scanBtn');
                if (isScanning) {
                    scanBtn.disabled = true;
                    scanBtn.innerHTML = '<span class="spinner"></span> Taranıyor...';
                } else {
                    scanBtn.disabled = false;
                    scanBtn.innerHTML = '<span>Taramayı Başlat</span>';
                }
            },

            displayResults() {
                const statsSection = document.getElementById('statsSection');
                const resultsContainer = document.getElementById('resultsContainer');
                const selectedStocks = getSelectedStocks();
                const stockLimit = parseInt(document.getElementById('stockLimit').value);
                const actualScanned = Math.min(selectedStocks.length, stockLimit);
                
                // İstatistikleri güncelle
                document.getElementById('totalScanned').textContent = actualScanned;
                document.getElementById('foundSignals').textContent = scanResults.length;
                document.getElementById('successRate').textContent = Utils.formatNumber((scanResults.length / actualScanned) * 100, 1) + '%';
                
                if (scanResults.length > 0) {
                    const avgRsi = scanResults.reduce((sum, r) => sum + r.currentRsi, 0) / scanResults.length;
                    document.getElementById('avgRsi').textContent = Utils.formatNumber(avgRsi, 1);
                } else {
                    document.getElementById('avgRsi').textContent = '0';
                }
                
                statsSection.style.display = 'grid';
                
                if (scanResults.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="no-results">
                            <h3>Sinyal Bulunamadı</h3>
                            <p>Belirlenen kriterlere uygun hisse bulunamadı. Parametreleri değiştirerek tekrar deneyin.</p>
                        </div>
                    `;
                    return;
                }
                
                // Sonuçları RSI yönüne göre sırala
                const rsiDirection = document.getElementById('rsiDirection').value;
                scanResults.sort((a, b) => {
                    if (rsiDirection === 'above') {
                        return b.currentRsi - a.currentRsi; // Yüksekten düşüğe
                    } else {
                        return a.currentRsi - b.currentRsi; // Düşükten yükseğe
                    }
                });
                
                let tableHTML = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Hisse</th>
                                <th>Sinyal</th>
                                <th>Güncel RSI</th>
                                <th>Önceki RSI</th>
                                <th>Değişim</th>
                                <th>Fiyat</th>
                                <th>Hacim</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                scanResults.forEach(result => {
                    const rsiClass = result.currentRsi < 20 ? 'rsi-low' : 
                                   result.currentRsi < 30 ? 'rsi-medium' : 'rsi-high';
                    
                    let signalClass = 'signal-rsi';
                    if (result.signalType.includes('BULLISH_DIV')) {
                        signalClass = 'signal-div';
                    } else if (result.signalType.includes('Aşırı Satım')) {
                        signalClass = 'signal-oversold';
                    } else if (result.signalType.includes('Güçlü')) {
                        signalClass = 'signal-strong';
                    } else if (result.signalType.includes('+')) {
                        signalClass = 'signal-both';
                    }
                    
                    const changeClass = result.rsiChange > 0 ? 'positive' : 'negative';
                    
                    tableHTML += `
                        <tr>
                            <td><strong class="symbol-link">${result.symbol}</strong></td>
                            <td><span class="signal-badge ${signalClass}">${result.signalType}</span></td>
                            <td class="rsi-value ${rsiClass}">${Utils.formatNumber(result.currentRsi)}</td>
                            <td class="rsi-value">${Utils.formatNumber(result.previousRsi)}</td>
                            <td class="price-change ${changeClass}">
                                ${result.rsiChange > 0 ? '+' : ''}${Utils.formatNumber(result.rsiChange)}
                            </td>
                            <td class="rsi-value">${Utils.formatNumber(result.currentPrice)} ₺</td>
                            <td class="volume-info">${Utils.formatVolume(result.volume)}</td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody></table>';
                resultsContainer.innerHTML = tableHTML;
            }
        };

        // Main Scan Function
        async function startScan() {
            if (isScanning) return;
            
            isScanning = true;
            scanResults = [];
            
            // Abort controller for scan cancellation
            scanAbortController = new AbortController();
            
            const timeframe = document.getElementById('timeframe').value;
            const rsiPeriod = Utils.clamp(parseInt(document.getElementById('rsiPeriod').value), 2, 50);
            const rsiThreshold = Utils.clamp(parseInt(document.getElementById('rsiThreshold').value), 10, 50);
            const rsiDirection = document.getElementById('rsiDirection').value;
            const stockLimit = Utils.clamp(parseInt(document.getElementById('stockLimit').value), 10, 500);
            
            const selectedStocks = getSelectedStocks();
            const stocksToScan = selectedStocks.slice(0, stockLimit);
            
            UIController.updateScanButton(true);
            UIController.showProgress();
            
            try {
                for (let i = 0; i < stocksToScan.length; i++) {
                    if (scanAbortController.signal.aborted) {
                        throw new Error('Scan cancelled');
                    }
                    
                    const symbol = stocksToScan[i];
                    UIController.updateProgress(i + 1, stocksToScan.length, symbol);
                    
                    try {
                        const result = await StockAnalyzer.analyzeStock(symbol, timeframe, rsiPeriod, rsiThreshold, rsiDirection);
                        if (result.success) {
                            scanResults.push(result.data);
                        }
                    } catch (error) {
                        console.error(`Analysis error for ${symbol}:`, error.message);
                    }
                    
                    // API rate limiting
                    await Utils.delay(CONFIG.API_DELAY);
                }
                
                UIController.displayResults();
                
            } catch (error) {
                if (error.message !== 'Scan cancelled') {
                    console.error('Scan error:', error);
                    document.getElementById('resultsContainer').innerHTML = `
                        <div class="alert alert-error">
                            <strong>Hata:</strong> Tarama sırasında bir hata oluştu. ${error.message}
                        </div>
                    `;
                }
            } finally {
                UIController.updateScanButton(false);
                UIController.hideProgress();
                isScanning = false;
                scanAbortController = null;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('BIST RSI Tarayıcı başlatıldı');
            
            // Theme initialization
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeButton(savedTheme);
            
            // Market filter initialization
            updateMarketCounts();
            updateFilterInfo();
            
            // Market filter event listeners
            document.querySelectorAll('.market-filter').forEach(filter => {
                filter.addEventListener('click', function() {
                    const market = this.getAttribute('data-market');
                    selectMarket(market);
                });
            });
            
            // Stock limit change listener
            document.getElementById('stockLimit').addEventListener('input', updateFilterInfo);
            
            // RSI direction and threshold change listeners
            document.getElementById('rsiDirection').addEventListener('change', updateFilterInfo);
            document.getElementById('rsiThreshold').addEventListener('input', updateFilterInfo);
            
            // Input validation
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    const min = parseInt(this.min);
                    const max = parseInt(this.max);
                    const value = parseInt(this.value);
                    
                    if (value < min) this.value = min;
                    if (value > max) this.value = max;
                    
                    if (this.id === 'stockLimit') {
                        updateFilterInfo();
                    }
                });
            });
        });

        // Export for testing
        if (typeof module !== 'undefined' && module.exports) {
            module.exports = {
                TechnicalAnalysis,
                Utils,
                CONFIG,
                BIST_STOCKS
            };
        }
    </script>
</body>
</html>
