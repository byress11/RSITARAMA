<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIST RSI Tarayƒ±cƒ± - CDC RSI Divergence V3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .control-group {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-item label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .control-item select,
        .control-item input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .control-item select:focus,
        .control-item input:focus {
            outline: none;
            border-color: #667eea;
        }

        .scan-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .scan-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .scan-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
        }

        .results {
            padding: 30px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .results-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .signal-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            color: white;
        }

        .signal-rsi {
            background: #28a745;
        }

        .signal-div {
            background: #dc3545;
        }

        .signal-both {
            background: #ffc107;
            color: #212529;
        }

        .rsi-value {
            font-weight: 600;
        }

        .rsi-low {
            color: #dc3545;
        }

        .rsi-medium {
            color: #ffc107;
        }

        .rsi-high {
            color: #28a745;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 1.1em;
        }

        @media (max-width: 768px) {
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }

            .results-table {
                font-size: 0.9em;
            }

            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ BIST RSI Tarayƒ±cƒ± v3.0</h1>
            <p>CDC RSI Divergence V3 - Pine Script Kriterleri</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label for="timeframe">Zaman Dilimi</label>
                    <select id="timeframe">
                        <option value="1d">G√ºnl√ºk (1d)</option>
                        <option value="4h">4 Saatlik (4h)</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label for="rsiPeriod">RSI Periyodu</label>
                    <input type="number" id="rsiPeriod" value="5" min="2" max="50">
                </div>
                
                <div class="control-item">
                    <label for="rsiThreshold">RSI E≈üiƒüi</label>
                    <input type="number" id="rsiThreshold" value="30" min="10" max="50">
                </div>
                
                <div class="control-item">
                    <label for="stockLimit">Hisse Limiti</label>
                    <input type="number" id="stockLimit" value="50" min="10" max="200">
                </div>
            </div>
            
            <button class="scan-button" onclick="startScan()" id="scanBtn">
                üîç Taramayƒ± Ba≈ülat
            </button>
        </div>

        <div class="progress" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Tarama ba≈ülƒ±yor...</div>
        </div>

        <div class="results" id="resultsSection">
            <div class="stats" id="statsSection" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalScanned">0</div>
                    <div class="stat-label">Taranan Hisse</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="foundSignals">0</div>
                    <div class="stat-label">Sinyal Bulunan</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successRate">0%</div>
                    <div class="stat-label">Ba≈üarƒ± Oranƒ±</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgRsi">0</div>
                    <div class="stat-label">Ortalama RSI</div>
                </div>
            </div>

            <div id="resultsContainer">
                <div class="no-results">
                    <h3>üéØ Tarama Yapmak ƒ∞√ßin Yukarƒ±daki Butona Tƒ±klayƒ±n</h3>
                    <p>BIST hisselerini RSI divergence kriterlerine g√∂re tarayacaƒüƒ±z</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // BIST Hisse Listesi
        const BIST_STOCKS = [
            // Ana Pazar
            'AKBNK', 'ARCLK', 'ASELS', 'BIMAS', 'EREGL', 'FROTO', 'GARAN', 'HALKB', 'ISCTR', 'KCHOL',
            'PGSUS', 'SAHOL', 'SISE', 'TKFEN', 'TUPRS', 'VAKBN', 'YKBNK', 'THYAO', 'TCELL', 'OTKAR',
            'MGROS', 'AEFES', 'AKSA', 'ALARK', 'AYGAZ', 'CIMSA', 'CCOLA', 'DOHOL', 'ENKAI', 'FENER',
            'GOLTS', 'GUBRF', 'HEKTS', 'IHLAS', 'KORDS', 'KOZAA', 'KOZAL', 'KRDMD', 'LOGO', 'MAVI',
            'PETKM', 'SASA', 'TOASO', 'ULKER', 'VESTL',
            // STARS Pazarƒ±
            'ALBRK', 'ALKIM', 'ANSGR', 'BAGFS', 'BANVT', 'BFREN', 'BRSAN', 'BURVA', 'CANTE', 'CEMTS',
            'CLEBI', 'CRFSA', 'DARDL', 'DERIM', 'DGNMO', 'DITAS', 'DURDO', 'ECILC', 'EGEEN', 'EMKEL',
            'FORTE', 'FRIGO', 'GENTS', 'GOODY', 'GOZDE', 'HATEK', 'HEPSI', 'HUBVC', 'INVEO', 'KAREL',
            'KARTN', 'KLMSN', 'KOTON', 'LINK', 'MAGEN', 'MARTI', 'MEGAP', 'MERKO', 'NETAS', 'PAPIL',
            'PARSN', 'PATEK', 'PENTA', 'PKENT', 'QUAGR', 'RAYSG', 'SELEC', 'SMART', 'SMRTG', 'TERA',
            'TTKOM', 'TURSG', 'VERTU', 'YAYLA'
        ];

        // CORS Proxy URL
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
        
        let scanResults = [];
        let isScanning = false;

        // RSI Hesaplama Fonksiyonu
        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return [];
            
            const gains = [];
            const losses = [];
            
            for (let i = 1; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                gains.push(change > 0 ? change : 0);
                losses.push(change < 0 ? Math.abs(change) : 0);
            }
            
            const rsiValues = [];
            
            // ƒ∞lk RSI hesabƒ± (SMA)
            let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
            let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
            
            if (avgLoss === 0) {
                rsiValues.push(100);
            } else {
                const rs = avgGain / avgLoss;
                rsiValues.push(100 - (100 / (1 + rs)));
            }
            
            // Wilder's smoothing ile devam eden RSI hesabƒ±
            for (let i = period; i < gains.length; i++) {
                avgGain = (avgGain * (period - 1) + gains[i]) / period;
                avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
                
                if (avgLoss === 0) {
                    rsiValues.push(100);
                } else {
                    const rs = avgGain / avgLoss;
                    rsiValues.push(100 - (100 / (1 + rs)));
                }
            }
            
            return rsiValues;
        }

        // EMA Hesaplama
        function calculateEMA(prices, period) {
            if (prices.length < period) return [];
            
            const ema = [];
            const multiplier = 2 / (period + 1);
            
            // ƒ∞lk EMA = SMA
            let sum = 0;
            for (let i = 0; i < period; i++) {
                sum += prices[i];
            }
            ema.push(sum / period);
            
            // Sonraki EMA deƒüerleri
            for (let i = period; i < prices.length; i++) {
                const currentEMA = (prices[i] * multiplier) + (ema[ema.length - 1] * (1 - multiplier));
                ema.push(currentEMA);
            }
            
            return ema;
        }

        // OHLC4 Hesaplama
        function calculateOHLC4(ohlcData) {
            return ohlcData.map(candle => {
                return (candle.open + candle.high + candle.low + candle.close) / 4;
            });
        }

        // Bullish Divergence Tespiti
        function detectBullishDivergence(ohlc4, rsi, params = {}) {
            const {
                shortLookback = 5,
                longLookback = 34,
                reversalPct = 0.02,
                oversoldLevel = 30,
                minRsiStrength = 5.0
            } = params;
            
            if (ohlc4.length < longLookback + 10 || rsi.length < longLookback + 10) {
                return false;
            }
            
            const currentPrice = ohlc4[ohlc4.length - 1];
            const currentRsi = rsi[rsi.length - 1];
            
            try {
                // Fiyatta Lower Low kontrol√º
                const recentPrices = ohlc4.slice(-shortLookback);
                const lowestRecent = Math.min(...recentPrices);
                const priceCondition1 = currentPrice > lowestRecent * (1 + reversalPct);
                
                const pastPrices = ohlc4.slice(-(longLookback + shortLookback), -longLookback);
                const lowestPast = Math.min(...pastPrices);
                const priceCondition2 = lowestRecent < lowestPast;
                
                const priceLL = priceCondition1 && priceCondition2;
                
                // RSI'da Higher Low kontrol√º
                const recentRsi = rsi.slice(-shortLookback);
                const lowestRecentRsi = Math.min(...recentRsi);
                const rsiCondition1 = currentRsi > lowestRecentRsi;
                
                const pastRsi = rsi.slice(-(longLookback + shortLookback), -longLookback);
                const lowestPastRsi = Math.min(...pastRsi);
                const rsiCondition2 = lowestRecentRsi > lowestPastRsi;
                const rsiCondition3 = lowestRecentRsi < oversoldLevel;
                const rsiCondition4 = currentRsi - lowestRecentRsi >= minRsiStrength;
                
                const rsiHL = rsiCondition1 && rsiCondition2 && rsiCondition3 && rsiCondition4;
                
                return priceLL && rsiHL;
                
            } catch (error) {
                return false;
            }
        }

        // Yahoo Finance'dan veri √ßekme
        async function fetchStockData(symbol, timeframe = '1d') {
            try {
                const period = timeframe === '1d' ? '6mo' : '3mo';
                const interval = timeframe;
                
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}.IS?period1=0&period2=9999999999&interval=${interval}&includePrePost=false`;
                const proxyUrl = CORS_PROXY + encodeURIComponent(url);
                
                const response = await fetch(proxyUrl);
                const data = await response.json();
                
                if (!data.chart || !data.chart.result || data.chart.result.length === 0) {
                    throw new Error('Veri bulunamadƒ±');
                }
                
                const result = data.chart.result[0];
                const timestamps = result.timestamp;
                const quote = result.indicators.quote[0];
                
                const ohlcData = [];
                for (let i = 0; i < timestamps.length; i++) {
                    if (quote.open[i] && quote.high[i] && quote.low[i] && quote.close[i]) {
                        ohlcData.push({
                            timestamp: timestamps[i],
                            open: quote.open[i],
                            high: quote.high[i],
                            low: quote.low[i],
                            close: quote.close[i],
                            volume: quote.volume[i] || 0
                        });
                    }
                }
                
                return ohlcData;
                
            } catch (error) {
                console.error(`${symbol} i√ßin veri √ßekme hatasƒ±:`, error);
                return null;
            }
        }

        // Hisse analizi
        async function analyzeStock(symbol, timeframe, rsiPeriod, rsiThreshold) {
            const data = await fetchStockData(symbol, timeframe);
            if (!data || data.length < 50) {
                return null;
            }
            
            const ohlc4 = calculateOHLC4(data);
            const closePrices = data.map(d => d.close);
            const rsi = calculateRSI(ohlc4, rsiPeriod);
            
            if (rsi.length < 2) {
                return null;
            }
            
            const currentRsi = rsi[rsi.length - 1];
            const previousRsi = rsi[rsi.length - 2];
            const currentPrice = data[data.length - 1].close;
            const volume = data[data.length - 1].volume;
            
            // Temel kriter: RSI < threshold VE y√ºkseli≈ü
            const basicCriteria = currentRsi < rsiThreshold && currentRsi > previousRsi;
            
            // Bullish divergence tespiti
            const bullishDiv = detectBullishDivergence(ohlc4, rsi, {
                shortLookback: 5,
                longLookback: 34,
                reversalPct: 0.02,
                oversoldLevel: rsiThreshold,
                minRsiStrength: 5.0
            });
            
            if (basicCriteria || bullishDiv) {
                const signalTypes = [];
                if (basicCriteria) signalTypes.push('RSI<' + rsiThreshold + '+Y√úKSELƒ∞≈û');
                if (bullishDiv) signalTypes.push('BULLISH_DIV');
                
                return {
                    symbol: symbol,
                    currentPrice: currentPrice,
                    currentRsi: currentRsi,
                    previousRsi: previousRsi,
                    rsiChange: currentRsi - previousRsi,
                    signalType: signalTypes.join(' + '),
                    volume: volume,
                    timestamp: data[data.length - 1].timestamp
                };
            }
            
            return null;
        }

        // Tarama ba≈ülatma
        async function startScan() {
            if (isScanning) return;
            
            isScanning = true;
            scanResults = [];
            
            const timeframe = document.getElementById('timeframe').value;
            const rsiPeriod = parseInt(document.getElementById('rsiPeriod').value);
            const rsiThreshold = parseInt(document.getElementById('rsiThreshold').value);
            const stockLimit = parseInt(document.getElementById('stockLimit').value);
            
            const scanBtn = document.getElementById('scanBtn');
            const progressSection = document.getElementById('progressSection');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const resultsContainer = document.getElementById('resultsContainer');
            
            scanBtn.disabled = true;
            scanBtn.innerHTML = '<div class="loading"></div> Taranƒ±yor...';
            progressSection.style.display = 'block';
            
            const stocksToScan = BIST_STOCKS.slice(0, stockLimit);
            let completed = 0;
            
            for (let i = 0; i < stocksToScan.length; i++) {
                const symbol = stocksToScan[i];
                
                try {
                    progressText.textContent = `${symbol} analiz ediliyor... (${i + 1}/${stocksToScan.length})`;
                    
                    const result = await analyzeStock(symbol, timeframe, rsiPeriod, rsiThreshold);
                    if (result) {
                        scanResults.push(result);
                    }
                    
                    completed++;
                    const progress = (completed / stocksToScan.length) * 100;
                    progressFill.style.width = progress + '%';
                    
                    // API rate limiting
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    console.error(`${symbol} analiz hatasƒ±:`, error);
                }
            }
            
            // Sonu√ßlarƒ± g√∂ster
            displayResults();
            
            // UI'yi sƒ±fƒ±rla
            scanBtn.disabled = false;
            scanBtn.innerHTML = 'üîç Taramayƒ± Ba≈ülat';
            progressSection.style.display = 'none';
            isScanning = false;
        }

        // Sonu√ßlarƒ± g√∂sterme
        function displayResults() {
            const statsSection = document.getElementById('statsSection');
            const resultsContainer = document.getElementById('resultsContainer');
            const stockLimit = parseInt(document.getElementById('stockLimit').value);
            
            // ƒ∞statistikleri g√ºncelle
            document.getElementById('totalScanned').textContent = stockLimit;
            document.getElementById('foundSignals').textContent = scanResults.length;
            document.getElementById('successRate').textContent = ((scanResults.length / stockLimit) * 100).toFixed(1) + '%';
            
            if (scanResults.length > 0) {
                const avgRsi = (scanResults.reduce((sum, r) => sum + r.currentRsi, 0) / scanResults.length).toFixed(1);
                document.getElementById('avgRsi').textContent = avgRsi;
            } else {
                document.getElementById('avgRsi').textContent = '0';
            }
            
            statsSection.style.display = 'grid';
            
            if (scanResults.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <h3>‚ùå Hi√ßbir hisse kriterleri kar≈üƒ±lamƒ±yor</h3>
                        <p>RSI e≈üiƒüini y√ºkseltmeyi veya farklƒ± parametreler denemeyi d√º≈ü√ºn√ºn</p>
                    </div>
                `;
                return;
            }
            
            // Sonu√ßlarƒ± RSI'ya g√∂re sƒ±rala
            scanResults.sort((a, b) => a.currentRsi - b.currentRsi);
            
            let tableHTML = `
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Hisse</th>
                            <th>Sinyal Tipi</th>
                            <th>G√ºncel RSI</th>
                            <th>√ñnceki RSI</th>
                            <th>RSI Deƒüi≈üim</th>
                            <th>G√ºncel Fiyat</th>
                            <th>Hacim</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            scanResults.forEach(result => {
                const rsiClass = result.currentRsi < 20 ? 'rsi-low' : 
                               result.currentRsi < 30 ? 'rsi-medium' : 'rsi-high';
                
                const signalClass = result.signalType.includes('BULLISH_DIV') ? 'signal-div' :
                                  result.signalType.includes('+') ? 'signal-both' : 'signal-rsi';
                
                tableHTML += `
                    <tr>
                        <td><strong>${result.symbol}</strong></td>
                        <td><span class="signal-badge ${signalClass}">${result.signalType}</span></td>
                        <td class="rsi-value ${rsiClass}">${result.currentRsi.toFixed(2)}</td>
                        <td>${result.previousRsi.toFixed(2)}</td>
                        <td style="color: ${result.rsiChange > 0 ? '#28a745' : '#dc3545'}">
                            ${result.rsiChange > 0 ? '+' : ''}${result.rsiChange.toFixed(2)}
                        </td>
                        <td>${result.currentPrice.toFixed(2)} ‚Ç∫</td>
                        <td>${result.volume.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            resultsContainer.innerHTML = tableHTML;
        }

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', function() {
            console.log('BIST RSI Tarayƒ±cƒ± hazƒ±r!');
        });
    </script>
</body>
</html>
